generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  username  String    @unique
  email     String?   @unique
  tcId      String?   @unique
  password  String
  address   String?
  active    Boolean   @default(true)
  role      Role      @default(STUDENT)
  Student   Student?
  Teacher   Teacher?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model Student {
  id             Int        @id @default(autoincrement())
  userId         Int        @unique
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate      DateTime?
  endDate        DateTime?
  class          Class?     @relation(fields: [classId], references: [id])
  studyGroup     StudyGroup @default(ILKOKUL_2_3)
  attempts       Attempt[]
  Progress       Progress[]
  active         Boolean    @default(true)
  gender         Gender     @default(OTHER)
  termsAgreed    Boolean    @default(false)
  introTestTaken Int        @default(0)
  classId        Int
}

model Lesson {
  id             Int              @id @default(autoincrement())
  title          String
  description    String?
  order          Int              @default(1)
  LessonExercise LessonExercise[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime?        @updatedAt
  Progress       Progress[]
}

model Exercise {
  id             Int              @id @default(autoincrement())
  title          String?
  pathName       String
  minDuration    Int              @default(180) // minimum Duration in seconds
  config         Json?
  createdAt      DateTime         @default(now())
  taken          Boolean          @default(false)
  Progress       Progress[]
  LessonExercise LessonExercise[]
}

model LessonExercise {
  id         Int        @id @default(autoincrement())
  lessonId   Int
  exerciseId Int
  order      Int?
  createdAt  DateTime   @default(now())
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  exercise   Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  Progress   Progress[]
}

model Attempt {
  id          Int      @id @default(autoincrement())
  studentId   Int
  student     Student  @relation(fields: [studentId], references: [id])
  correct     Int?
  wpm         Float? // words per minute measured
  wpf         Int?     @default(1) // words per frame
  variant     TestType @default(FASTREADING)
  durationSec Int?
  createdAt   DateTime @default(now())
}

model Progress {
  id               Int            @id @default(autoincrement())
  studentId        Int
  lessonId         Int
  lessonExerciseId Int
  exerciseId       Int
  done             Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime?      @updatedAt
  student          Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  exercise         Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  lessonExercise   LessonExercise @relation(fields: [lessonExerciseId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonExerciseId]) // progress is tracked per student per lessonExercise occurrence
}

model Article {
  id          Int        @id @default(autoincrement())
  title       String
  description String     @db.Text
  studyGroup  StudyGroup @default(ILKOKUL_2_3)
  category    Category   @relation(fields: [categoryId], references: [id])
  hasQuestion Boolean    @default(false)
  active      Boolean    @default(true)
  tests       Json?
  categoryId  Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime?  @updatedAt
}

model ArticleTest {
  id        Int       @id @default(autoincrement())
  question  String
  answer    String
  options   Json
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model Category {
  id          Int        @id @default(autoincrement())
  title       String
  description String?
  studyGroup  StudyGroup @default(ILKOKUL_2_3)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime?  @updatedAt
  Article     Article[]
}

model Words {
  id          Int               @id @default(autoincrement())
  word        String            @unique
  similarWord String            @unique
  studyGroups WordsStudyGroup[]
  wpc         Int // words per count
  lpw         Int // letters per word
  createdAt   DateTime          @default(now())
  updatedAt   DateTime?         @updatedAt
}

model WordsStudyGroup {
  id      Int        @id @default(autoincrement())
  group   StudyGroup
  wordsId Int
  words   Words      @relation(fields: [wordsId], references: [id])
}

model Class {
  id         Int        @id @default(autoincrement())
  name       String
  teacher    Teacher?   @relation(fields: [teacherId], references: [id])
  studyGroup StudyGroup @default(ILKOKUL_2_3)
  teacherId  Int?
  students   Student[]
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime?  @updatedAt
}

model Teacher {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  class     Class[]
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

enum Role {
  ADMIN
  STUDENT
  TEACHER
}

enum TestType {
  FASTREADING
  UNDERSTANDING
  FASTVISION
}

enum StudyGroup {
  ILKOKUL_2_3
  ILKOKUL_4
  ORTAOKUL
  LISE
  UNIVERSITE
  DOKTORA
  GENEL
  DISLEKSI
  TIP
  IELTS
  LGS_HAZIRLIK
  TYT_AYT_HAZIRLIK
  DEMO
}

enum Gender {
  MALE
  FEMALE
  OTHER
}
